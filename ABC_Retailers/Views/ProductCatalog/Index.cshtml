@model Dictionary<string, List<ABC_Retailers.Models.ProductCatalog>>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var user = HttpContextAccessor.HttpContext?.User;
    if (user != null && user.IsInRole("Admin"))
    {
        Layout = "_LayoutAdmin";
    }
    else
    {
        Layout = "_LayoutCustomer";
    }
}

@{
    ViewData["Title"] = "Product Catalog";
}
<style>
    .catalog-header {
        background-color: #434343;
        color: white;
        border-radius: 8px;
        padding: 16px 24px;
        margin-bottom: 24px;
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

        .header-top h1 {
            font-size: 26px;
            color: #BE9A60;
            margin: 0;
        }

    .btn-add {
        background: #BE9A60;
        color: white;
        font-weight: 600;
        border-radius: 6px;
        padding: 6px 12px;
        text-decoration: none;
    }

    .header-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .fade-out {
        transition: opacity 0.6s ease-out;
    }

        .fade-out.hide {
            opacity: 0;
        }

    .search-bar {
        display: flex;
        gap: 8px;
    }

        .search-bar input {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
        }

        .search-bar button, .btn-reset {
            background: #BE9A60;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

    .btn-cart-icon {
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 6px;
    }

    .cart-count {
        position: absolute;
        top: -6px;
        right: -8px;
        background: #B9375E;
        color: white;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 50%;
    }

    .btn-cart-icon {
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 6px;
    }

    .product-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
    }

    .product-card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border-radius: 8px;
        }

    .btn-view {
        background: #BE9A60;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
    }
</style>

<div class="catalog-header">
    <div class="header-top">
        <h1>🛍️ ABC Retailers</h1>
        @if (User.IsInRole("Admin"))
        {
            <a asp-action="Create" class="btn-add">+ Add Product</a>
        }
    </div>
    <div class="header-bottom">
        <form asp-action="Index" method="get" class="search-bar">
            <input type="text" name="search" placeholder="Search products..." value="@ViewBag.SearchQuery" />
            <button type="submit">Search</button>
            <a asp-action="Index" class="btn-reset">Reset</a>
        </form>

        @if (!User.IsInRole("Admin"))
        {
            <div class="cart-section">
                <a asp-controller="Cart" asp-action="Index" style="position:relative; text-decoration:none; color:white; font-size:22px;">
                🛒
                <span class="cart-count" style="
            position:absolute;
            top:-10px;
            right:-12px;
            background:#B9375E;
            color:white;
            font-size:14px;
            padding:4px 8px;
            border-radius:50%;
        ">
                    @ViewBag.CartCount ?? 0
                </span>
            </a>
        </div>
}
    </div>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success fade-out">@TempData["Message"]</div>
}

@foreach (var category in Model)
{
    <h3>@category.Key</h3>
    <div class="product-container">
        @foreach (var p in category.Value)
        {
            <div class="product-card">
                <img src="@(!string.IsNullOrEmpty(p.ImageUrl) ? p.ImageUrl : "/images/placeholder.png")"
                     alt="@p.ProductName" />

                <h3>@p.ProductName</h3>
                <p>@p.Description</p>
                <p>@p.Price.ToString("C")</p>

               
    <a class="btn-view"
       asp-action="Details"
       asp-route-category="@p.Category"
       asp-route-rowKey="@p.RowKey">
        View
    </a>

                @if (!User.IsInRole("Admin"))
                {
    <button class="btn-cart-icon" data-productid="@p.RowKey" title="Add to Cart">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#BE9A60" class="bi bi-cart-plus" viewBox="0 0 16 16">
            <path d="M8 7.5a.5.5 0 0 1 .5.5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 .5-.5z" />
            <path d="M0 1.5A.5.5 0 0 1 .5 1h1l1.4 4h11.6l-1.5 8H4L2 2H.5zM5 12a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm6 1a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
        </svg>
    </button>
    }

    @if (User.IsInRole("Admin"))
    {
        <div style="margin-top:8px;">
            <a class="btn-view"
               asp-action="Edit"
               asp-route-partitionKey="@p.PartitionKey"
               asp-route-rowKey="@p.RowKey"
               style="background:#BE9A60;">Edit</a>

            <a class="btn-view"
               asp-action="Delete"
               asp-route-partitionKey="@p.PartitionKey"
               asp-route-rowKey="@p.RowKey"
               style="background:#B9375E;">Delete</a>
        </div>
    }
</div>

        }
    </div>
}

<script>
     setTimeout(() => {
         document.querySelectorAll('.fade-out').forEach(el => {
             el.classList.add('hide');
             setTimeout(() => el.style.display = 'none', 600);
         });
     }, 3000);


           document.querySelectorAll('.btn-cart-icon').forEach(button => {
        button.addEventListener('click', async () => {
            const productId = button.getAttribute('data-productid');

            const response = await fetch('/Cart/Add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, quantity: 1 })
            });

            if (response.ok) {
                // Update cart badge instantly
                let countElem = document.querySelector('.cart-count');
                if (countElem) {
                    countElem.textContent = parseInt(countElem.textContent) + 1;
                }
                alert('✅ Product added to cart!');
            } else {
                alert('❌ Failed to add product to cart.');
            }
        });
    });


</script>


